# DNASPEC Context Fundamentals Skill

## When to Activate

**激活时机**：当用户需要理解或应用以下概念时：
- "什么是上下文" 或 "为什么上下文重要"
- "上下文容量" 或 "token限制"
- "上下文失效" 或 "lost-in-the-middle"
- "上下文工程" 或 "context engineering"
- 需要理解其他DNASPEC技能的基础知识
- 初次使用DNASPEC系统时

**作为前置知识**：这是所有其他DNASPEC技能的基础建议先熟悉本技能。

---

## Core Concepts

### 1. 什么是上下文（Context）？

**定义**：上下文是AI系统在处理任务时可访问的所有信息集合。

**组成**：
```
上下文 = 用户请求 + 系统提示词 + 相关文档 + 代码库 + 历史对话 + 工具输出
```

**类比**：
- 上下文就像**工作台**：台面越大，能同时处理的信息越多
- 上下文就像**短期记忆**：记忆容量越大，能考虑的因素越多

### 2. 为什么上下文重要？

**上下文质量 = AI性能的关键因素**

| 上下文特征 | 对AI性能的影响 |
|-----------|--------------|
| **充足性** | 信息不足 → 幻觉、错误推理 |
| **相关性** | 噪音过多 → 分心、效率低下 |
| **组织性** | 结构混乱 → 认知负担、检索失败 |
| **时机性** | 过早加载 → 浪费token；过晚提供 → 错失时机 |

### 3. 上下文容量限制

**硬限制**：
```
GPT-4: 128K tokens (~8.2M characters)
Claude Opus: 200K tokens (~12.8M characters)
```

**软限制**（性能考虑）：
- **10K tokens**：快速响应，高质量（推荐）
- **50K tokens**：平衡性能和质量
- **100K+ tokens**：可能lost-in-the-middle，质量下降

### 4. 格式塔认知原则

**整体性原则（Wholeness）**：
- **整体 > 部分之和**：完整上下文比片段之和更有效
- **完形倾向**：AI会自动补全不完整的上下文（可能正确或错误）

**从简单到复杂（Simplicity to Complexity）**：
```
原子任务 → 复合任务 → 复杂系统
  ↑         ↑           ↑
小上下文   中上下文   大上下文
```

**连续改进原则**：
- 每次迭代优化上下文
- 从最小可行上下文开始
- 逐步增加必要的复杂性

### 5. 上下文失效模式

**Lost-in-the-Middle现象**：
```
[开始] 强检索
       ↓
[中间] ⚠️ 检索能力急剧下降
       ↓
[结束] 强检索
```
**解决方案**：
- 关键信息放在开头或结尾
- 使用渐进式信息披露
- 分段处理

**上下文毒化（Context Poisoning）**：
- **原因**：矛盾信息、过时文档、错误示例
- **症状**：AI困惑、反复摇摆、错误决策
- **防御**：版本控制、明确优先级、验证机制

**上下文分心（Distraction）**：
- **原因**：无关信息过多
- **症状**：关注细节、偏离目标
- **防御**：强过滤、关键词匹配、相关性评分

**上下文冲突（Clash）**：
- **原因**：多源信息不一致
- **症状**：不确定性、犹豫不决
- **防御**：明确优先级、冲突解决协议

---

## Practical Guidance

### 1. 评估当前上下文

**快速检查清单**：
```yaml
✓ 上下文是否充足？（信息是否完整）
✓ 上下文是否相关？（是否有多余噪音）
✓ 上下文是否有序？（逻辑结构清晰）
✓ 上下文是否及时？（在适当时机提供）
✓ 是否存在失效模式？（毒化、分心、冲突）
```

**使用calculator脚本**：
```bash
python scripts/calculator.py --request "你的任务" --context-file context.json
```

### 2. 优化上下文策略

**策略1：渐进式披露（Progressive Disclosure）**
```
Level 0: 核心概念（<500 tokens）  → 快速理解
Level 1: 基础应用（<1000 tokens） → 常见场景
Level 2: 中级场景（<2000 tokens） → 复杂任务
Level 3: 高级应用（<3000 tokens） → 大型项目
```

**策略2：原子化上下文**
- 每个任务使用独立工作区
- 上下文隔离，避免干扰
- 任务间只传递必要信息

**策略3：动态上下文组装**
- 根据任务需求动态加载信息
- 按需检索，不预加载全部
- 智能缓存和复用

### 3. 防止上下文爆炸

**上下文爆炸的信号**：
```yaml
warning_signs:
  - 单次对话超过50K tokens
  - AI开始重复相同错误
  - AI遗忘之前的约定
  - 响应质量明显下降
```

**防御措施**：
1. **使用独立工作区**：每个任务独立上下文
2. **局部智能体**：分散认知负担
3. **原子任务**：大任务分解为小任务
4. **信息分层**：按需加载不同层次的信息
5. **明确作用域**：严格限定任务边界

---

## Examples

### Example 1: Lost-in-the-Middle 识别

**场景**：给AI提供100个相关文档，要求找出最佳方案

**问题**：AI只关注第1-10个和第90-100个文档

**解决方案**：
1. 使用`context-analysis`技能识别失效模式
2. 分批处理文档（每批10个）
3. 渐进式综合结果

### Example 2: 上下文毒化检测

**场景**：AI在不同版本文档间反复摇摆

**问题**：v1.0和v2.0文档同时存在，产生矛盾

**解决方案**：
1. 使用版本控制标记文档
2. 明确优先级：v2.0 > v1.0
3. 使用`constraint-generator`添加版本约束

### Example 3: 防止上下文爆炸

**场景**：需要重构100个文件的大型项目

**问题**：单次对话加载所有文件会超过token限制

**解决方案**：
1. 使用`task-decomposer`分解为10个子项目
2. 每个子项目使用独立工作区
3. 使用`architect`协调整体进度

---

## Guidelines

### 上下文设计原则

**1. 最小化原则**
- 只包含必要信息
- 移除冗余内容
- 每个token都有价值

**2. 结构化原则**
- 使用清晰的层次结构
- 用标题、列表、表格组织
- 使用格式化突出重点

**3. 相关性原则**
- 信息与任务高度相关
- 过滤无关细节
- 使用相关性评分过滤

**4. 时机性原则**
- 在适当时机提供信息
- 避免过早加载
- 支持按需检索

**5. 可验证性原则**
- 上下文来源明确
- 信息可以验证
- 版本可追溯

### 质量检查清单

**完整性检查**：
```yaml
✓ 所有必需的信息都已提供
✓ 没有遗漏的关键细节
✓ 上下文足以完成任务
```

**相关性检查**：
```yaml
✓ 每个信息都与任务相关
✓ 无关信息已被过滤
✓ 噪音水平在可接受范围
```

**一致性检查**：
```yaml
✓ 信息之间没有矛盾
✓ 版本和优先级明确
✓ 冲突已有解决方案
```

**容量检查**：
```yaml
✓ token数量在合理范围
✓ 预计不会超过模型限制
✓ 预留增长空间
```

---

## Integration

### 作为前置知识

本技能是以下技能的基础：
- **context-analysis**：分析上下文质量
- **context-optimization**：优化上下文结构
- **task-decomposer**：任务分解需要理解上下文限制
- **所有其他技能**：都需要理解上下文的基本概念

### 协作模式

**推荐学习路径**：
```
context-fundamentals (本技能)
         ↓
context-analysis
         ↓
context-optimization
         ↓
其他核心技能（task-decomposer等）
```

### 配合使用的技能

1. **context-analysis**：
   - 本技能提供理论
   - context-analysis提供实践工具

2. **task-decomposer**：
   - 本技能解释为什么需要分解
   - task-decomposer提供分解方法

3. **architect**：
   - 本技能解释上下文限制
   - architect在限制内设计系统

---

## Key Achievements

学完本技能后，你将能够：

✅ **理解**：什么是上下文，为什么重要
✅ **识别**：上下文失效模式（lost-in-the-middle, poisoning等）
✅ **应用**：格式塔认知原则优化上下文
✅ **设计**：渐进式信息披露策略
✅ **防止**：上下文爆炸和常见陷阱
✅ **评估**：上下文质量和容量
✅ **优化**：使用DNASPEC工具链改进上下文

---

## References

详细文档请查看：
- `references/context-theory.md`：上下文理论详解
- `references/failure-modes.md`：失效模式完整目录
- `references/gestalt-principles.md`：格式塔原则在上下文工程中的应用
- `references/best-practices.md`：行业最佳实践案例

---

*DNASPEC Context Fundamentals Skill v1.0*
*作为所有DNASPEC技能的基础，帮助理解上下文工程的核心概念*
