# specs/context_optimization.spec.yaml
spec_version: "1.0"
name: "context-optimization"
display_name: "Context Optimization"
description: "Optimize context quality based on specific goals"
version: "1.0.0"
category: "optimization"

parameters:
  - name: "context"
    type: "string"
    description: "The context to optimize"
    required: true
  - name: "optimization_goals"
    type: "array"
    items:
      type: "string"
      enum: ["clarity", "relevance", "completeness", "conciseness", "consistency"]
    default: ["clarity", "completeness"]
    description: "Goals to optimize for"

implementation:
  instruction_template: |
    请根据以下目标优化以下上下文：
    
    原始上下文：
    "{{context}}"
    
    优化目标：
    {% for goal in optimization_goals %}
    - {{goal}}: {% if goal == 'clarity' %}提高表达清晰度{% elif goal == 'relevance' %}增强与目标的相关性{% elif goal == 'completeness' %}补充缺失的关键信息{% elif goal == 'conciseness' %}提高简洁性{% elif goal == 'consistency' %}确保内容一致性{% endif %}
    {% endfor %}
    
    请返回优化后的上下文，并说明应用了哪些优化措施：
    
    优化后上下文：
    [在此提供优化后的上下文]
    
    应用的优化措施：
    - [优化措施1]
    - [优化措施2]
    - [优化措施3]
    
    优化前后对比分析：
    [简要说明优化效果]

  result_processor: |
    import re
    try:
        # 从响应中提取优化后的上下文
        response_text = response['raw_response'] if isinstance(response, dict) and 'raw_response' in response else str(response)
        
        # 提取优化后的上下文
        optimized_context = ""
        context_match = re.search(r'优化后上下文：\s*\n*(.*?)(?:\n\s*应用的优化措施|$)', response_text, re.DOTALL)
        if context_match:
            optimized_context = context_match.group(1).strip()
        else:
            # 如果没有明确标记，假设整个响应都是优化后的内容
            optimized_context = response_text
        
        # 提取应用的优化措施
        optimizations = []
        optimizations_match = re.search(r'应用的优化措施：\s*\n*((?:\s*-\s*[^\n]+\n?)*)', response_text)
        if optimizations_match:
            opt_text = optimizations_match.group(1)
            optimizations = [item.strip().replace('- ', '').strip() for item in opt_text.split('\n') if item.strip()]
        
        # 估计改进效果（简化实现）
        original_length = len(context.get('context', ''))
        optimized_length = len(optimized_context)
        
        # 计算改进指标（简化计算）
        improvements = {}
        for goal in context.get('optimization_goals', []):
            if goal == 'conciseness':
                # 如果优化目标是简洁性，且长度减少了，则认为有所改进
                improvements[goal] = max(-0.5, min(0.5, 0.1 if optimized_length < original_length else -0.1))
            else:
                # 对其他目标，暂时假设有改进
                improvements[goal] = 0.2  # 假设改进0.2
        
        return {
            "original_context": context.get('context', ''),
            "optimized_context": optimized_context,
            "applied_optimizations": [opt for opt in optimizations if opt],
            "improvement_metrics": improvements,
            "original_analysis": {  # 这里应该调用分析技能，简化处理
                "context_length": original_length,
                "token_count": max(1, original_length // 4)
            },
            "optimized_analysis": {
                "context_length": optimized_length,
                "token_count": max(1, optimized_length // 4)
            }
        }
    except Exception as e:
        return {
            "original_context": context.get('context', ''),
            "optimized_context": context.get('context', ''),  # 优化失败，返回原文
            "applied_optimizations": [],
            "improvement_metrics": {goal: 0.0 for goal in context.get('optimization_goals', [])},
            "original_analysis": {
                "context_length": len(context.get('context', '')),
                "token_count": max(1, len(context.get('context', '')) // 4)
            },
            "optimized_analysis": {
                "context_length": len(context.get('context', '')),
                "token_count": max(1, len(context.get('context', '')) // 4)
            },
            "error": f"Optimization processing error: {str(e)}"
        }