# specs/context_analysis.spec.yaml
spec_version: "1.0"
name: "context-analysis"
display_name: "Context Analysis"
description: "Analyze context quality across multiple dimensions"
version: "1.0.0"
category: "analysis"

parameters:
  - name: "context"
    type: "string"
    description: "The context to analyze"
    required: true
  - name: "metrics"
    type: "array"
    items:
      type: "string"
      enum: ["clarity", "relevance", "completeness", "consistency", "efficiency"]
    default: ["clarity", "relevance", "completeness"]
    description: "Metrics to evaluate in the analysis"

implementation:
  instruction_template: |
    请对以下上下文进行专业分析评估：
    
    上下文内容：
    "{{context}}"
    
    分析指标：
    {% for metric in metrics %}
    - {{metric}}: {% if metric == 'clarity' %}清晰度 - 内容表达的明确程度{% elif metric == 'relevance' %}相关性 - 与目标的相关程度{% elif metric == 'completeness' %}完整性 - 关键信息的完备程度{% elif metric == 'consistency' %}一致性 - 内容之间的逻辑一致性{% elif metric == 'efficiency' %}效率 - 信息密度和简洁性{% endif %} (0-1分)
    {% endfor %}
    
    请以JSON格式返回分析结果：
    {
      "metrics": {
        {% for metric in metrics %}
        "{{metric}}": 评分 (0-1),
        {% endfor %}
      },
      "suggestions": ["建议1", "建议2", "建议3"],
      "issues": ["问题1", "问题2"]
    }
    
    并提供简要分析总结。

  result_processor: |
    import json, re
    try:
        # 从AI响应中提取JSON
        response_text = response['raw_response'] if isinstance(response, dict) and 'raw_response' in response else str(response)
        
        # 查找JSON部分
        json_pattern = r'\{[^{}]*(?:\{[^{}]*[^{}]*\}[^{}]*)*\}'  # 简单的嵌套JSON匹配
        import re
        json_matches = re.findall(r'(\{(?:[^{}]|(?R))*\})', response_text.replace('\n', ''))
        if not json_matches:
            # 尝试更简单的模式
            start_idx = response_text.find('{')
            end_idx = response_text.rfind('}') + 1
            if start_idx != -1 and end_idx > start_idx:
                json_str = response_text[start_idx:end_idx]
                try:
                    result = json.loads(json_str)
                except:
                    # 如果JSON解析失败，返回基本结构
                    result = {
                        "metrics": {m: 0.5 for m in context.get('metrics', ['clarity'])},
                        "suggestions": ["AI响应未能提供结构化JSON结果"],
                        "issues": ["分析结果格式不符合预期"]
                    }
            else:
                result = {
                    "metrics": {m: 0.3 for m in context.get('metrics', ['clarity'])},
                    "suggestions": ["无法从AI响应中提取分析结果"],
                    "issues": ["响应格式错误"]
                }
        else:
            result = json.loads(json_matches[0])
        
        # 验证和标准化结果
        if 'metrics' not in result:
            result['metrics'] = {}
        
        valid_metrics = ['clarity', 'relevance', 'completeness', 'consistency', 'efficiency']
        for metric in valid_metrics:
            if metric not in result['metrics']:
                result['metrics'][metric] = 0.5  # 默认中等评分
        
        # 确保所有指标分数在0-1之间
        for metric, score in result['metrics'].items():
            if isinstance(score, (int, float)):
                result['metrics'][metric] = max(0.0, min(1.0, float(score)))
        
        # 确保数组字段存在
        if 'suggestions' not in result:
            result['suggestions'] = []
        if 'issues' not in result:
            result['issues'] = []
        
        # 添加其他必要字段
        result['context_length'] = len(context.get('context', ''))
        result['token_count'] = max(1, len(context.get('context', '')) // 4)  # 估算
        
        return result
    except Exception as e:
        return {
            "metrics": {m: 0.0 for m in context.get('metrics', ['clarity'])},
            "suggestions": [f"结果处理错误: {str(e)}"],
            "issues": ["无法解析AI分析结果"],
            "context_length": len(context.get('context', '')),
            "token_count": max(1, len(context.get('context', '')) // 4)
        }