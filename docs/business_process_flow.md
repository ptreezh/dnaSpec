# DNASPEC 系统 - 业务流程图

## 1. 系统整体架构流程

```
用户请求
    ↓
DNASPEC 主入口
    ↓
请求解析与路由
    ↓
-------------------------------------------------
| Hook 系统                                         |
|  ↓                                              |
| 插件加载 → 工具注册 → 代理创建 → 技能调用           |
-------------------------------------------------
    ↓
根据请求类型选择处理模块
    ↓
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   Agent 模块     │    │   Tool 模块      │    │   MCP 模块       │
│                 │    │                 │    │                 │
│ • DataAnalysis  │    │ • LSP           │    │ • Qwen 集成     │
│ • CodeGen       │    │ • AST-Grep      │    │ • 外部服务       │
│ • DocGen        │    │ • Grep          │    │ • 协议支持       │
│ • Testing       │    │ • Glob          │    │                 │
│ • Planning      │    │ • Bash          │    │                 │
│ • Optimization  │    │                 │    │                 │
│ • Security      │    │                 │    │                 │
└─────────────────┘    └─────────────────┘    └─────────────────┘
    ↓                         ↓                         ↓
结果处理 ←──────────────── 结果合并 ←───────────────── 结果返回
    ↓
输出格式化
    ↓
返回用户
```

## 2. 上下文分析业务流程

```
开始
  ↓
接收上下文分析请求
  ↓
验证输入参数
  ↓
┌─────────────────────────────────────────────────┐
│ Hook 触发: skill_before_invoke                 │
│ - 记录请求日志                                │
│ - 验证用户权限                                │
└─────────────────────────────────────────────────┘
  ↓
调用 ContextAnalyzerAgent
  ↓
┌─────────────────────────────────────────────────┐
│ ContextAnalyzerAgent 处理流程                  │
│ 1. 解析上下文内容                             │
│ 2. 评估清晰度、相关性、完整性等指标            │
│ 3. 生成改进建议                               │
│ 4. 构造结果对象                               │
└─────────────────────────────────────────────────┘
  ↓
┌─────────────────────────────────────────────────┐
│ Hook 触发: agent_context_updated               │
│ - 更新上下文状态                              │
│ - 记录分析结果                                │
└─────────────────────────────────────────────────┘
  ↓
格式化输出结果
  ↓
┌─────────────────────────────────────────────────┐
│ Hook 触发: skill_after_invoke                  │
│ - 记录处理完成日志                            │
│ - 更新统计信息                                │
└─────────────────────────────────────────────────┘
  ↓
返回分析结果给用户
  ↓
结束
```

## 3. 架构设计业务流程

```
开始
  ↓
接收架构设计请求
  ↓
解析需求描述
  ↓
┌─────────────────────────────────────────────────┐
│ Hook 触发: agent_before_process                │
│ - 验证架构设计权限                            │
│ - 初始化设计环境                              │
└─────────────────────────────────────────────────┘
  ↓
选择合适的架构设计Agent
  ↓
┌─────────────────────────────────────────────────┐
│ ArchitectureAgent 处理流程                     │
│ 1. 分析需求特征                               │
│ 2. 匹配架构模式                               │
│ 3. 生成架构组件                               │
│ 4. 评估架构质量                               │
│ 5. 输出架构建议                               │
└─────────────────────────────────────────────────┘
  ↓
┌─────────────────────────────────────────────────┐
│ Hook 触发: agent_after_process                 │
│ - 记录设计结果                                │
│ - 更新架构知识库                              │
└─────────────────────────────────────────────────┘
  ↓
应用架构约束生成器
  ↓
┌─────────────────────────────────────────────────┐
│ ConstraintGeneratorAgent 处理流程              │
│ 1. 分析架构风险                               │
│ 2. 生成技术约束                               │
│ 3. 生成业务约束                               │
│ 4. 生成安全约束                               │
└─────────────────────────────────────────────────┘
  ↓
合并架构设计和约束
  ↓
返回完整架构方案
  ↓
结束
```

## 4. 任务分解业务流程

```
开始
  ↓
接收任务分解请求
  ↓
分析任务描述
  ↓
┌─────────────────────────────────────────────────┐
│ Hook 触发: tool_before_execute                 │
│ - 记录任务分解请求                            │
│ - 验证任务描述完整性                          │
└─────────────────────────────────────────────────┘
  ↓
调用 TaskDecomposerAgent
  ↓
┌─────────────────────────────────────────────────┐
│ TaskDecomposerAgent 处理流程                   │
│ 1. 识别任务边界                               │
│ 2. 识别依赖关系                               │
│ 3. 创建任务层次结构                           │
│ 4. 估算任务复杂度                             │
│ 5. 分配任务优先级                             │
└─────────────────────────────────────────────────┘
  ↓
验证分解结果
  ↓
┌─────────────────────────────────────────────────┐
│ Hook 触发: tool_after_execute                  │
│ - 记录分解结果                                │
│ - 更新任务知识库                              │
└─────────────────────────────────────────────────┘
  ↓
生成任务执行计划
  ↓
返回分解后的任务列表
  ↓
结束
```

## 5. Qwen 集成业务流程

```
Qwen 用户发起 MCP 请求
  ↓
DNASPEC MCP 服务器接收请求
  ↓
验证 MCP 协议兼容性
  ↓
┌─────────────────────────────────────────────────┐
│ Hook 触发: hook_invoked                        │
│ - 记录 MCP 请求                               │
│ - 验证用户认证                                │
└─────────────────────────────────────────────────┘
  ↓
解析 MCP 方法调用
  ↓
根据方法名路由到对应处理器
  ↓
┌─────────────────────────────────────────────────┐
│ MCP 处理器执行流程                             │
│ • dnaspec/context-analyze → ContextAnalyzer   │
│ • dnaspec/generate-constraints → ConstraintGen│
│ • dnaspec/modulize → ModulizerAgent           │
└─────────────────────────────────────────────────┘
  ↓
执行相应技能
  ↓
格式化 MCP 响应
  ↓
┌─────────────────────────────────────────────────┐
│ Hook 触发: tool_output_processed               │
│ - 记录处理结果                                │
│ - 更新 MCP 统计                               │
└─────────────────────────────────────────────────┘
  ↓
返回 MCP 响应给 Qwen
  ↓
Qwen 显示结果给用户
  ↓
结束
```

## 6. 插件生命周期流程

```
插件安装
  ↓
┌─────────────────────────────────────────────────┐
│ Hook 触发: plugin_loaded                       │
│ - 加载插件配置                                │
│ - 初始化插件资源                              │
└─────────────────────────────────────────────────┘
  ↓
插件初始化
  ↓
┌─────────────────────────────────────────────────┐
│ Hook 触发: plugin_initialized                  │
│ - 注册所有技能                                │
│ - 启动后台服务                                │
│ - 连接外部系统                                │
└─────────────────────────────────────────────────┘
  ↓
插件运行中（处理请求）
  ↓
检测到关闭信号
  ↓
┌─────────────────────────────────────────────────┐
│ Hook 触发: plugin_before_shutdown              │
│ - 停止接收新请求                              │
│ - 完成正在进行的处理                          │
│ - 保存持久化数据                              │
└─────────────────────────────────────────────────┘
  ↓
插件关闭
  ↓
┌─────────────────────────────────────────────────┐
│ Hook 触发: plugin_after_shutdown               │
│ - 释放所有资源                                │
│ - 断开外部连接                                │
│ - 记录关闭日志                                │
└─────────────────────────────────────────────────┘
  ↓
插件卸载
```